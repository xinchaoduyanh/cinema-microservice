# ============================================
# Makefile for Cinema Management Backend
# ============================================
# Quick commands for development workflow
#
# Usage:
#   make dev          - Start all services in Docker
#   make dev-infra    - Start only Redis & Kafka
#   make logs         - View logs
#   make stop         - Stop all services
#   make restart      - Restart services

.PHONY: help dev dev-infra dev-local logs logs-node logs-redis logs-kafka stop restart clean ps test

# Default target
help:
	@echo "üöÄ Cinema Management Backend - Available Commands:"
	@echo ""
	@echo "  Development:"
	@echo "    make dev          - Start all services (Redis, Kafka, NestJS) in Docker"
	@echo "    make dev-infra    - Start only infrastructure (Redis, Kafka)"
	@echo "    make dev-local    - Start infra + run NestJS locally (pnpm dev)"
	@echo ""
	@echo "  Logs:"
	@echo "    make logs         - View all logs"
	@echo "    make logs-node    - View NestJS logs"
	@echo "    make logs-redis   - View Redis logs"
	@echo "    make logs-kafka   - View Kafka logs"
	@echo ""
	@echo "  Control:"
	@echo "    make stop         - Stop all services"
	@echo "    make restart      - Restart all services"
	@echo "    make restart-node - Restart only NestJS"
	@echo "    make ps           - Show running containers"
	@echo ""
	@echo "  Cleanup:"
	@echo "    make clean        - Stop and remove all containers"
	@echo "    make clean-all    - Stop, remove containers and volumes"
	@echo ""
	@echo "  Testing:"
	@echo "    make test         - Run tests"
	@echo "    make test-watch   - Run tests in watch mode"

# ============================================
# Development Commands
# ============================================

# Start all services in Docker (recommended)
dev:
	@echo "üöÄ Starting all services in Docker..."
	docker-compose -f docker-compose.dev.yml up -d
	@echo "‚úÖ Services started! View logs with: make logs"
	@echo "üìä Kafka UI: http://localhost:18082 (admin/secret)"
	@echo "üìä Redis Insight: http://localhost:5544"

# Start only infrastructure (Redis + Kafka)
dev-infra:
	@echo "üîß Starting infrastructure (Redis + Kafka)..."
	docker-compose -f docker-compose.dev.yml up -d redis kafka redisinsight kafkaui
	@echo "‚úÖ Infrastructure started!"
	@echo "üìù Now run: pnpm dev"

# Start infrastructure + run NestJS locally
dev-local: dev-infra
	@echo "üíª Starting NestJS services locally..."
	pnpm dev

# ============================================
# Logs Commands
# ============================================

# View all logs
logs:
	docker-compose -f docker-compose.dev.yml logs -f

# View NestJS logs
logs-node:
	docker-compose -f docker-compose.dev.yml logs -f node

# View Redis logs
logs-redis:
	docker-compose -f docker-compose.dev.yml logs -f redis

# View Kafka logs
logs-kafka:
	docker-compose -f docker-compose.dev.yml logs -f kafka

# ============================================
# Control Commands
# ============================================

# Stop all services
stop:
	@echo "üõë Stopping all services..."
	docker-compose -f docker-compose.dev.yml down
	@echo "‚úÖ All services stopped!"

# Restart all services
restart:
	@echo "üîÑ Restarting all services..."
	docker-compose -f docker-compose.dev.yml restart
	@echo "‚úÖ Services restarted!"

# Restart only NestJS
restart-node:
	@echo "üîÑ Restarting NestJS services..."
	docker-compose -f docker-compose.dev.yml restart node
	@echo "‚úÖ NestJS restarted!"

# Show running containers
ps:
	docker-compose -f docker-compose.dev.yml ps

# ============================================
# Cleanup Commands
# ============================================

# Stop and remove containers
clean:
	@echo "üßπ Cleaning up containers..."
	docker-compose -f docker-compose.dev.yml down
	@echo "‚úÖ Cleanup complete!"

# Stop, remove containers and volumes
clean-all:
	@echo "üßπ Cleaning up containers and volumes..."
	docker-compose -f docker-compose.dev.yml down -v
	@echo "‚úÖ Full cleanup complete!"

# ============================================
# Testing Commands
# ============================================

# Run tests
test:
	pnpm test

# Run tests in watch mode
test-watch:
	pnpm test:watch

# ============================================
# Database Commands (for local PostgreSQL if needed)
# ============================================

# Start PostgreSQL (if using local DB instead of cloud)
db-local:
	docker-compose up -d db

# Stop PostgreSQL
db-stop:
	docker-compose stop db

# ============================================
# Utility Commands
# ============================================

# Install dependencies
install:
	pnpm install

# Build all services
build:
	pnpm build

# Check environment
check-env:
	@echo "üîç Checking environment..."
	@echo "Redis URL: $$(grep REDIS_URL .env | cut -d '=' -f2)"
	@echo "Kafka Brokers: $$(grep KAFKA_BROKERS .env | cut -d '=' -f2)"
	@echo ""
	@echo "Docker env:"
	@echo "Redis URL: $$(grep REDIS_URL .env.docker | cut -d '=' -f2)"
	@echo "Kafka Brokers: $$(grep KAFKA_BROKERS .env.docker | cut -d '=' -f2)"

# Health check
health:
	@echo "üè• Checking service health..."
	@curl -s http://localhost:3300/api/health || echo "‚ùå Auth service not responding"
	@curl -s http://localhost:3301/api/health || echo "‚ùå User service not responding"
	@curl -s http://localhost:3302/api/health || echo "‚ùå Movie service not responding"
	@echo "‚úÖ Health check complete!"
